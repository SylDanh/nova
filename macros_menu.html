<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Macro principale d'affichage du menu appelée par les templates.
 */
<DEFMACRO NAME="MENU_MAIN">
	<nav id="main-menu" class="main-menu">
		<MACRO NAME="MENU_INDEX" />
		<FUNC NAME="MENU_COLLECTIONS" EXCLUDE="'partenaires'" />
	</nav>
</DEFMACRO>

/**
 * Menu des index.
 */
<DEFMACRO NAME="MENU_INDEX">
	<section class="main-menu__section main-menu__section--indexes">
		<h2 class="main-menu__section-title">[@INDEX]</h2>
		<ul class="main-menu__list">
			<!--[ Auteurs ]-->
			<LET VAR="tableindex">#_TP_persons</LET>
			<LET VAR="tabletypes">#_TP_persontypes</LET>
			<LET VAR="filtre">type = 'auteur'</LET>

			<LOOP NAME="menu_index_list" TABLE="[#TABLEINDEX], [#TABLETYPES]" SELECT="DISTINCT(idtype), title, altertitle" WHERE="[#FILTRE] AND [#TABLEINDEX].idtype = [#TABLETYPES].id AND [#TABLEINDEX].status GT 0" ORDER="[#TABLETYPES].rank">
				<li><a href="[#IDTYPE|makeurlwithid]"><FUNC NAME="BASE_ML_TITRE" INDEX="TRUE" /></a></li>
			</LOOP>

			<!--[ Mots-clés ]-->
			<LET VAR="tableindex">#_TP_entries</LET>
			<LET VAR="tabletypes">#_TP_entrytypes</LET>
			<LET VAR="filtre">type LIKE 'mot%cle%' AND lang = '[#SITELANG]'</LET>

			<!--[ Il faut tester l'existence de l'index dans la langue de navigation ]-->
			<LET VAR="sitelang_keywords"><LOOP NAME="menu_index_list"></LOOP></LET>

			<IF COND="[#SITELANG_KEYWORDS]">
				[#SITELANG_KEYWORDS|trim]
			<ELSE />
				<!--[ Affichage de l'index dans la langue principale du site ]-->
				<LET VAR="filtre">type LIKE 'mot%cle%' AND lang = '[#MAINLANG]'</LET>
				<LOOP NAME="menu_index_list"></LOOP>
			</IF>

			<!--[ Autres types d'index ]-->
			<LET VAR="filtre">type NOT LIKE 'mot%cle%' AND class != 'indexavances' AND class != 'collections'</LET>
			<LOOP NAME="menu_index_list"></LOOP>

			<!--[ Index par annees ]-->
			<IF COND="[#OPTIONS.OPTIONSAFFICHAGE.AFFICHAGEINDEXANNUEL]">
				<li><a href="[#SITEINFOS.URL]/?page=years">[@INDEX_PAR_ANNEES]</a></li>
			</IF>

			<!--[ Index par langues ]-->
			<IF COND="[#OPTIONS.OPTIONSAFFICHAGE.AFFICHAGEINDEXPARLANGUE]">
				<li><a href="[#SITEINFOS.URL]/?page=lang">[@INDEX_PAR_LANGUES]</a></li>
			</IF>
		</ul>
	</section>
</DEFMACRO>

/**
 * Afficher des collections dans le menu.
 * @param {string} [include] - Inclure des collections selon leur identifier. Penser à wrapper chaque nom entre guillemets. Exemple : INCLUDE="'presentation', 'informations'".
 * @param {string} [exclude] - Idem exclusion des collections.
 */
<DEFFUNC NAME="MENU_COLLECTIONS" OPTIONAL="include, exclude">
	<LET VAR="filter">
		<IF COND="[#INCLUDE]">
			AND identifier IN ([#INCLUDE])
		</IF>
		<IF COND="[#EXCLUDE]">
			AND identifier NOT IN ([#EXCLUDE])
		</IF>
	</LET>

	<LOOP NAME="menu_collections" TABLE="publications" SELECT="id, titre, altertitre, identifier" WHERE="idparent = 0 AND type = 'collection' AND id NOT IN ([#ISSUES_COLLECTIONS_ID]) [#FILTER]" ORDER="rank">
		<section class="main-menu__section main-menu__section--collection main-menu__section--identifier--[#IDENTIFIER]">
			<h2 class="main-menu__section-title"><FUNC NAME="BASE_TITRE_ENTITE" TITREALTER="oui" /></h2>

			<LOOP NAME="menu_collections_entities" TABLE="entities" SELECT="id, class, type" WHERE="idparent = '[#ID]' AND id [#NOT_IN_TRADUCTIONS] AND class IN ('publications', 'textes', 'liens')" ORDER="rank">
				<BEFORE>
					<ul class="main-menu__list">
				</BEFORE>

				<DO>
					<IF COND="[#CLASS] EQ 'textes'">
						<li class="main-menu__item main-menu__item--class-[#CLASS]">
							<IF COND="![%RELATIONS_TRADUCTION_PARENT_UNIQUE]">
								<a href="[#ID|makeurlwithid]"><FUNC NAME="BASE_TITRE_ENTITE" TITREALTER="oui" /></a>
							<ELSE />
								<!--[ Affichage des traductions dans la langue de navigation ]-->
								<LOOP NAME="menu_collections_entities_traduction" SELECT="id, titre, altertitre" TABLE="textes, relations" WHERE="id2 = '[#ID]' AND id1 = textes.identity AND langue = '[#SITELANG]' AND nature = 'traduction'" LIMIT="1">
									<a href="[#ID|makeurlwithid]"><FUNC NAME="BASE_ML_TITRE" /></a>
									<ALTERNATIVE>
										<a href="[#ID|makeurlwithid]"><FUNC NAME="BASE_TITRE_ENTITE" TITREALTER="oui" /></a>
									</ALTERNATIVE>
								</LOOP>
							</IF>
						</li>

						<ELSEIF COND="[#CLASS] EQ 'liens'" />
							<LOOP NAME="menu_collections_entities_lien" TABLE="liens" WHERE="id = '[#ID]'" SELECT="titre, url, vignette">
								<!--[ Possibilité d'ajouter une icone spécifique format 16x16 via le champ #VIGNETTE ]-->
								<IF COND="[#VIGNETTE]">
									<LET VAR="li_icon">style="list-style-image: url([#VIGNETTE])"</LET>
								</IF>
								<LET VAR="href">[#ID|makeurlwithid]</LET>
								<IF COND="[#TYPE] EQ 'noticedesite' AND [#URL]">
									<LET VAR="href">[#URL]</LET>
								</IF>
								<li class="main-menu__item main-menu__item--class-[#CLASS]" [#LI_ICON]>
									<a href="[#HREF]">[#TITRE]</a>
								</li>
							</LOOP>

						<ELSE />
							<li class="main-menu__item main-menu__item--class-[#CLASS]">
								<a href="[#ID|makeurlwithid]">
									<FUNC NAME="BASE_TITRE_ENTITE" TITREALTER="oui" />
								</a>
							</li>
						</IF>
					</li>
				</DO>

				<AFTER>
					</ul>
				</AFTER>
			</LOOP>
		</section>
	</LOOP>
</DEFFUNC>