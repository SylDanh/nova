<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Initialisation de la page.
 */
<DEFMACRO NAME="HOME_INIT">
	<!--[ Dépendances additionnelles ]-->
	<USE MACROFILE="macros_publication.html" />

	<!--[ Chercher maintenant les actualités pour savoir combien de colonnes sur la home ]-->
	<LET VAR="section_actualites"><MACRO NAME="HOME_ACTUALITES" /></LET>
</DEFMACRO>

/**
 * Macro principale appelée par le template.
 */
<DEFMACRO NAME="HOME_MAIN">
	<!--[ Colonne actualités si besoin ]-->
	<LET VAR="main_col_size"><IF COND="[#SECTION_ACTUALITES]">8<ELSE/>12</IF></LET>
	<div class="row">
		<div class="col-md-[#MAIN_COL_SIZE|trim]">
			<MACRO NAME="HOME_BILLETS" />
			<MACRO NAME="HOME_LATEST_ISSUE" />
			<MACRO NAME="HOME_RUBRIQUES" />
		</div>
		<IF COND="[#SECTION_ACTUALITES]">
			<div class="col-md-4">
				[#SECTION_ACTUALITES]
			</div>
		</IF>
	</div>
</DEFMACRO>

/**
 * Billets de présentation.
 */
<DEFMACRO NAME="HOME_BILLETS">
	<LOOP NAME="home_billets" SELECT="titre, altertitre, texte, identifier" TABLE="textessimples" WHERE="type = 'billet' AND idparent = 0" ORDER="rank">
		<BEFORE>
			<section id="home-billets" class="home-billets">
		</BEFORE>
		<DO>
			<div class="home-billet">
				<LET VAR="ml_titre">
					<FUNC NAME="BASE_ML_TITRE" />
				</LET>
				<IF COND="[#ML_TITRE] AND [#IDENTIFIER] NE 'presentation'">
					<h2 class="home-billet__titre">[#ML_TITRE]</h2>
				</IF>
				<FUNC NAME="BASE_ML_TEXTE" ML_VAR="[#TEXTE]" />
			</div>
		</DO>
		<AFTER>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Affichage du dernier numéro.
 */
<DEFMACRO NAME="HOME_LATEST_ISSUE">
	<section id="home-latest-issue" class="home-latest-issue">
		<LOOP NAME="home_latest_issue" TABLE="publications" WHERE="type = 'numero' AND paraitre != 1" ORDER="rank DESC" LIMIT="0,1">
			<BEFORE>
				<section id="home-latest-issue" class="home-latest-issue">
					<FUNC NAME="BASE_SECTION_HEADER" TITLE="[@DERNIER_NUMERO]" ICON="book" SECTION_ID="home-latest-issue" />
			</BEFORE>
			<MACRO NAME="PUBLICATION_PUBLI" />
			<AFTER>
				</section>
			</AFTER>
		</LOOP>
	</section>
</DEFMACRO>

/**
 * Affichage des rubriques.
 */
<DEFMACRO NAME="HOME_RUBRIQUES">
	<LET VAR="id_collection_rubriques">
		<LOOP NAME="home_rubriques_get_id_collection_rubriques" TABLE="publications" SELECT="id" WHERE="type='collection' AND identifier='rubriques'">[#ID]</LOOP>
	</LET>
	<LOOP NAME="home_rubriques" 
		TABLE="publications"
		SELECT="id, titre, altertitre"
		WHERE="idparent = '[#ID_COLLECTION_RUBRIQUES]' AND type = 'rubrique'"
		ORDER="rank">

		<BEFORE>
			<LET VAR="home_nb_rubriques" GLOBAL="1">[#NBRESULTS]</LET>
			<section id="home-rubriques" class="home-rubriques">
				<FUNC NAME="BASE_SECTION_HEADER" TITLE="[@RUBRIQUES]" ICON="folder-open" SECTION_ID="home-rubriques" />
				<div class="home-rubriques__contents">
		</BEFORE>

		<DO>
			<MACRO NAME="HOME_CONTENU_RUBRIQUE" />
		</DO>

		<AFTER>
				</div>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Affichage des derniers documents de la rubrique.
 */
<DEFMACRO NAME="HOME_CONTENU_RUBRIQUE">
	<!--[ FIX d'un bug Lodelscript où [#ID] dans le <AFTER> n'est plus l'id de la rubrique mais celui du dernier enfant rencontré ]-->
	<LET VAR="id_rubrique">[#ID|makeurlwithid]</LET>

	<LOOP NAME="home_contenu_rubrique"
		TABLE="textes, relations"
		SELECT="identity, idparent, id, titre, soustitre, altertitre, LEFT(texte,1) AS texte, LEFT(alterfichier,1) AS alterfichier, documentcliquable, datepubli, langue, numerodocument"
		WHERE="id1 = '[#ID]' AND nature = 'P' AND id2 = textes.identity"
		ORDER="datepubli">

		<BEFORE>
			<div class="home-rubrique">
				<h3 class="home-rubrique__titre"><a href="[#ID_RUBRIQUE]">[#TITRE]</a></h3>
				<ul class="toc-contents home-rubrique__contents">
		</BEFORE>

		<DO>
			<li class="toc-contents__li toc-contents__li--class-[#CLASS]">
				<FUNC NAME="PUBLICATION_LI_TEXTE" AFFICHER_DATEPUBLI="1" />
			</li>
		</DO>

		<AFTER>
				</ul>
				<a class="home-rubrique__more" href="[#ID_RUBRIQUE]">[@SOMMAIRE_DE_CETTE_RUBRIQUE] <FUNC NAME="BASE_ICON" ICON="chevron-right"/></a>
			</div>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Actualités.
 */
<DEFMACRO NAME="HOME_ACTUALITES">
	<LOOP NAME="home_actualites" TABLE="textes" WHERE="type='actualite'" SELECT="id, titre, soustitre, altertitre, datepubli" ORDER="datepubli DESC, datemisenligne DESC, rank DESC">
		<BEFORE>
			<section id="home-actualites" class="home-actualites">
				<FUNC NAME="BASE_SECTION_HEADER" TITLE="[@ACTUALITES]" ICON="newspaper" SECTION_ID="home-actualites" />
				<ul class="home-actualites__list">
		</BEFORE>
		<DO>
			<li class="home-actualites__item">
				<a href="[#ID|makeurlwithid]"><FUNC NAME="BASE_ML_TITRE" /></a>
			</li>
		</DO>
		<AFTER>
				</ul>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>